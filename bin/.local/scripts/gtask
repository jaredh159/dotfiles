#!/usr/bin/env bash
set -euo pipefail

TASKS_DIR="$HOME/gertie/tasks"

clean_merged() {
  if [[ ! -d "$TASKS_DIR" ]]; then
    echo "Tasks directory not found: $TASKS_DIR"
    exit 1
  fi

  local red=$'\e[31m'
  local green=$'\e[32m'
  local reset=$'\e[0m'

  local -a to_delete=()
  local -a to_keep=()

  # first pass: collect merged vs unmerged
  for dir in "$TASKS_DIR"/*/; do
    [[ -d "$dir" ]] || continue

    dirname=$(basename "$dir")

    # extract branch name from directory
    # old format: slug--MM-DD-YYYY (double dash)
    # new format: slug-MMDDYY (single dash + 6 digits)
    if [[ "$dirname" == *"--"* ]]; then
      branch="${dirname%%--*}"
    else
      branch="${dirname%-[0-9][0-9][0-9][0-9][0-9][0-9]}"
    fi

    if [[ -z "$branch" || "$branch" == "$dirname" ]]; then
      continue
    fi

    merged=$(gh pr list \
      --repo gertrude-app/gertrude \
      --head "$branch" \
      --state merged \
      --json number \
      --jq 'length' 2>/dev/null || echo "0")

    if [[ "$merged" -gt 0 ]]; then
      to_delete+=("$dir")
    else
      to_keep+=("$dirname")
    fi
  done

  # print deleted in red
  for dir in ${to_delete[@]+"${to_delete[@]}"}; do
    dirname=$(basename "$dir")
    echo "${red}removing: ${dirname}${reset}"
  done

  # print remaining in green
  for dirname in ${to_keep[@]+"${to_keep[@]}"}; do
    echo "${green}keeping:  ${dirname}${reset}"
  done

  # now do the actual cleanup in background
  for dir in ${to_delete[@]+"${to_delete[@]}"}; do
    dir="${dir%/}"  # strip trailing slash
    dirname=$(basename "$dir")
    tmux kill-session -t "$dirname" 2>/dev/null || true
    rm -rf "$dir" &
    disown
  done
}

# handle --clean flag
if [[ "${1:-}" == "--clean" ]]; then
  clean_merged
  exit 0
fi

slug="${1:-}"

if [[ -z "$slug" ]]; then
  echo "usage: gtask <slug>"
  echo "       gtask --clean"
  exit 1
fi

datestamp=$(date +"%m%d%y")
target="$TASKS_DIR/${slug}-${datestamp}"

if [ -d "$target" ]; then
  echo "Target already exists: $target"
  exit 1
fi

mkdir -p "$target"

(
  git clone --depth 50 --single-branch git@github.com:gertrude-app/gertrude.git "$target"
  git -C "$target" checkout -b "$slug"

  cp ~/gertie/swift/api/.env "$target/swift/api/.env"
  cp ~/gertie/swift/iosapp/config/Local.xcconfig "$target/swift/iosapp/config/"
  cp ~/gertie/web/dash/app/.env.local "$target/web/dash/app/.env.local"
  cp ~/gertie/web/site/.env.local "$target/web/site/.env.local"

  cd "$target/swift"
  just migrate-up
  pnpm install
  git restore -- pnpm-lock.yaml
  just check

  cd "$target/web"
  pnpm install
  just check
) > /dev/null 2>&1 &
disown

echo "Created: $target"

#!/usr/bin/env bash
set -euo pipefail

TASKS_DIR="$HOME/gertie/tasks"

clean_merged() {
  if [[ ! -d "$TASKS_DIR" ]]; then
    echo "Tasks directory not found: $TASKS_DIR"
    exit 1
  fi

  local red=$'\e[31m'
  local green=$'\e[32m'
  local reset=$'\e[0m'

  local -a to_delete=()
  local -a to_keep=()

  # first pass: collect merged vs unmerged
  for dir in "$TASKS_DIR"/*/; do
    [[ -d "$dir" ]] || continue

    dirname=$(basename "$dir")

    # extract branch name from directory
    # old format: slug--MM-DD-YYYY (double dash)
    # new format: slug-MMDDYY (single dash + 6 digits)
    if [[ "$dirname" == *"--"* ]]; then
      branch="${dirname%%--*}"
    else
      branch="${dirname%-[0-9][0-9][0-9][0-9][0-9][0-9]}"
    fi

    if [[ -z "$branch" || "$branch" == "$dirname" ]]; then
      continue
    fi

    merged=$(gh pr list \
      --repo gertrude-app/gertrude \
      --head "$branch" \
      --state merged \
      --json number \
      --jq 'length' 2>/dev/null || echo "0")

    if [[ "$merged" -gt 0 ]]; then
      to_delete+=("$dir")
    else
      to_keep+=("$dirname")
    fi
  done

  # print deleted in red
  for dir in ${to_delete[@]+"${to_delete[@]}"}; do
    dirname=$(basename "$dir")
    echo "${red}removing: ${dirname}${reset}"
  done

  # print remaining in green
  for dirname in ${to_keep[@]+"${to_keep[@]}"}; do
    echo "${green}keeping:  ${dirname}${reset}"
  done

  # kill processes on common dev ports
  for port in 8080 8081 3000 4243 6006; do
    pids=$(lsof -ti:"$port" 2>/dev/null) || true
    [[ -n "$pids" ]] && kill -9 $pids 2>/dev/null || true
  done

  # kill tmux sessions and panes first
  for dir in ${to_delete[@]+"${to_delete[@]}"}; do
    dir="${dir%/}"  # strip trailing slash
    dirname=$(basename "$dir")

    # kill tmux session by name
    tmux kill-session -t "$dirname" 2>/dev/null || true

    # kill any tmux panes whose cwd is inside this directory
    tmux list-panes -a -F '#{pane_id} #{pane_current_path}' 2>/dev/null | while read -r pane_id pane_path; do
      if [[ "$pane_path" == "$dir"* ]]; then
        tmux kill-pane -t "$pane_id" 2>/dev/null || true
      fi
    done
  done

  # two-pass deletion to handle stubborn directories
  for pass in 1 2; do
    for dir in ${to_delete[@]+"${to_delete[@]}"}; do
      dir="${dir%/}"
      [[ -d "$dir" ]] && rm -rf "$dir" 2>/dev/null || true
    done
  done
}

# handle --clean flag
if [[ "${1:-}" == "--clean" ]]; then
  clean_merged
  exit 0
fi

slug="${1:-}"

if [[ -z "$slug" ]]; then
  echo "usage: gtask <slug>"
  echo "       gtask --clean"
  exit 1
fi

datestamp=$(date +"%m%d%y")
target="$TASKS_DIR/${slug}-${datestamp}"

if [ -d "$target" ]; then
  echo "Target already exists: $target"
  exit 1
fi

mkdir -p "$target"

(
  set +e
  log=$(mktemp)
  failed=0
  run() { "$@" >> "$log" 2>&1 || failed=1; }

  run git clone --depth 50 --single-branch git@github.com:gertrude-app/gertrude.git "$target"
  run git -C "$target" checkout -b "$slug"

  run cp ~/gertie/swift/api/.env "$target/swift/api/.env"
  run cp ~/gertie/swift/iosapp/config/Local.xcconfig "$target/swift/iosapp/config/"
  run cp ~/gertie/web/dash/app/.env.local "$target/web/dash/app/.env.local"
  run cp ~/gertie/web/site/.env.local "$target/web/site/.env.local"

  cd "$target/swift"
  run just migrate-up
  run pnpm install
  run git restore -- pnpm-lock.yaml
  # granular swift checks (so failures don't skip cache warming)
  run just nuke-test-db
  run just build
  run just macapp-xcode-build
  run just iosapp-xcode-build
  run just test
  run just lint

  cd "$target/web"
  run pnpm install
  # granular web checks (so failures don't skip cache warming)
  run just lint
  run just format-check
  run just typecheck
  run just test
  run just build-storybook

  [[ $failed -eq 1 ]] && mv "$log" "$target/.gtask-error.log" || rm -f "$log"
) &
disown

echo "Created: $target"
